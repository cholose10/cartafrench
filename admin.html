<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Carta - Tilo Caf√©</title>
  <style>
    body { font-family: Arial, sans-serif; margin:20px; background:#f7f3f0; color:#333;}
    h1 { text-align: center; color:#806250; }
    form { background:#fff; padding:15px; border-radius:10px; margin-bottom:20px;}
    input,textarea,select { width:100%; padding:8px; margin:6px 0; border:1px solid #ccc; border-radius:6px;}
    table { width:100%; border-collapse:collapse; background:#fff;}
    th,td { border:1px solid #ddd; padding:8px; text-align:left;}
    th { background:#806250; color:white; }
    img { max-width:60px; border-radius:6px; }
    button { cursor:pointer; background:#806250; color:white; border:none; padding:6px 10px; border-radius:6px; }
    button:hover { background:#a07b68; }
    #preview { max-width:100px; margin-top:5px; display:block; }
    #search { width:40%; padding:8px; border-radius:6px; border:1px solid #ccc; }
    #btnSubir {
      position: fixed; bottom: 25px; right: 25px;
      background: #8c6954; color: white;
      border: none; border-radius: 50%;
      width: 50px; height: 50px; font-size: 1.5rem;
      cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      display: none; transition: opacity 0.3s ease;
    }
    #btnSubir:hover { background: #6b4e3d; }
  </style>
</head>
<body>
  <h1>Panel de Administraci√≥n - Tilo Caf√©</h1>

  <!-- TOKEN -->
  <div style="margin-bottom:15px; background:#eee; padding:10px; border-radius:8px;">
    <label for="token">Token de GitHub:</label><br>
    <input type="password" id="token" placeholder="Pega tu token aqu√≠" style="width:70%; padding:8px;">
    <button onclick="saveToken()">Guardar Token</button>
    <button onclick="clearToken()">Borrar Token</button>
    <p id="tokenStatus"></p>
  </div>

  <!-- BUSCADOR -->
  <div style="margin-bottom:15px;">
    <input type="text" id="search" placeholder="Buscar producto... (Enter para buscar)">
  </div>

  <!-- FORMULARIO -->
  <form id="form">
    <input type="hidden" id="editIndex">
    <label>Nombre</label>
    <input type="text" id="nombre" required>

    <label>Descripci√≥n</label>
    <textarea id="descripcion" required></textarea>

    <label>Precio</label>
    <input type="number" id="precio" required>

    <label>Imagen (ej: img/foto.jpg)</label>
    <input type="text" id="imagen" required oninput="previewImage()">
    <img id="preview" src="" alt="Vista previa">

    <!-- üÜï CAMPO DE CATEGOR√çAS INTELIGENTE -->
    <label>Categor√≠a</label>
    <input list="categorias" id="categoria" required placeholder="Eleg√≠ o escrib√≠ una categor√≠a">
    <datalist id="categorias">
      <option value="CAFETER√çA">
      <option value="COMIDAS">
      <option value="POSTRES">
      <option value="TRAGOS">
      <option value="REFRESCOS">
      <option value="ENTRADAS">
      <option value="EVENTOS">
      <option value="PROMOCIONES">
      <option value="S√ÅNDWICHES">
    </datalist>

    <button type="submit">Guardar</button>
  </form>

  <!-- TABLA -->
  <h2 id="tablaTitulo">Productos</h2>
  <table>
    <thead>
      <tr>
        <th>Imagen</th><th>Nombre</th><th>Descripci√≥n</th><th>Categor√≠a</th><th>Precio</th><th>Acciones</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <!-- Bot√≥n para subir -->
  <button id="btnSubir" title="Subir">‚¨ÜÔ∏è</button>

  <script>
    const USERNAME = "frenchtilo-boop";
    const REPO = "cartatilo";
    const FILE_PATH = "productos.json";

    let productos = [];

    // üü§ TOKEN
    function saveToken(){
      const t=document.getElementById('token').value.trim();
      if(t){ 
        localStorage.setItem('github_token',t); 
        document.getElementById('token').value=''; 
        document.getElementById('tokenStatus').innerText="‚úÖ Token guardado."; 
      }
    }
    function clearToken(){ 
      localStorage.removeItem('github_token'); 
      document.getElementById('tokenStatus').innerText="‚ö†Ô∏è Token borrado."; 
    }
    function getToken(){ return localStorage.getItem('github_token'); }

    // üü§ CARGAR PRODUCTOS
    async function loadProducts(){
      const url=`https://raw.githubusercontent.com/${USERNAME}/${REPO}/main/${FILE_PATH}`;
      const res=await fetch(url);
      productos=await res.json();
      render(productos);
    }

    // üü§ RENDERIZAR TABLA (edit/eliminar seguros)
    function render(lista = productos){
      const tb=document.getElementById('tbody'); tb.innerHTML='';
      lista.forEach((p)=>{
        tb.innerHTML+=`
          <tr>
            <td><img src="${p.imagen}" alt=""></td>
            <td>${p.nombre}</td>
            <td>${p.descripcion}</td>
            <td>${p.categoria}</td>
            <td>$${p.precio}</td>
            <td>
              <button onclick="editByName('${p.nombre.replace(/'/g, "\\'")}')">Editar</button>
              <button onclick="delByName('${p.nombre.replace(/'/g, "\\'")}')">Eliminar</button>
            </td>
          </tr>`;
      });
    }

    function editByName(nombre){
      const i=productos.findIndex(p=>p.nombre===nombre);
      if(i!==-1) edit(i);
    }
    function delByName(nombre){
      const i=productos.findIndex(p=>p.nombre===nombre);
      if(i!==-1) del(i);
    }

    // üü§ BUSCAR
    document.getElementById('search').addEventListener('keypress', function(e){
      if(e.key === 'Enter'){
        e.preventDefault();
        const q=this.value.toLowerCase();
        const filtrados=productos.filter(p=> 
          p.nombre.toLowerCase().includes(q) || 
          p.descripcion.toLowerCase().includes(q) ||
          p.categoria.toLowerCase().includes(q)
        );
        render(filtrados);
        document.getElementById('tablaTitulo').scrollIntoView({ behavior: "smooth" });
      }
    });

    // üü§ PREVIEW
    function previewImage(){
      const src=document.getElementById('imagen').value.trim();
      document.getElementById('preview').src=src || '';
    }

    // üü§ GUARDAR EN GITHUB
    async function saveToGitHub(newContent){
      const TOKEN=getToken();
      if(!TOKEN){ alert("‚ö†Ô∏è Necesitas guardar tu token primero."); return; }

      const apiUrl=`https://api.github.com/repos/${USERNAME}/${REPO}/contents/${FILE_PATH}`;
      const getRes=await fetch(apiUrl,{ headers:{Authorization:`token ${TOKEN}`} });
      const data=await getRes.json();

      const updateRes=await fetch(apiUrl,{
        method:"PUT",
        headers:{
          "Authorization":`token ${TOKEN}`,
          "Content-Type":"application/json"
        },
        body:JSON.stringify({
          message:"Actualizaci√≥n desde admin.html",
          content:btoa(unescape(encodeURIComponent(newContent))),
          sha:data.sha
        })
      });

      if(updateRes.ok){ alert("‚úÖ Cambios guardados en GitHub."); }
      else{ alert("‚ùå Error al guardar en GitHub."); }
    }

    // üü§ FORMULARIO
    document.getElementById('form').onsubmit=function(e){
      e.preventDefault();

      // üÜï Agregar autom√°ticamente nueva categor√≠a al datalist
      const categoriaInput = document.getElementById('categoria');
      const datalist = document.getElementById('categorias');
      const nuevaCategoria = categoriaInput.value.trim();
      if (nuevaCategoria) {
        const existe = Array.from(datalist.options).some(opt => opt.value.toLowerCase() === nuevaCategoria.toLowerCase());
        if (!existe) {
          const option = document.createElement('option');
          option.value = nuevaCategoria;
          datalist.appendChild(option);
        }
      }

      const idx=document.getElementById('editIndex').value;
      const prod={
        nombre:document.getElementById('nombre').value,
        descripcion:document.getElementById('descripcion').value,
        precio:parseFloat(document.getElementById('precio').value),
        imagen:document.getElementById('imagen').value,
        categoria:document.getElementById('categoria').value
      };
      if(idx===''){ productos.push(prod);} 
      else { productos[idx]=prod; document.getElementById('editIndex').value='';}
      render(productos);
      this.reset();
      document.getElementById('preview').src='';
      saveToGitHub(JSON.stringify(productos,null,2));
    }

    // üü§ EDITAR
    function edit(i){
      const p=productos[i];
      document.getElementById('nombre').value=p.nombre;
      document.getElementById('descripcion').value=p.descripcion;
      document.getElementById('precio').value=p.precio;
      document.getElementById('imagen').value=p.imagen;
      document.getElementById('categoria').value=p.categoria;
      document.getElementById('editIndex').value=i;
      document.getElementById('preview').src=p.imagen;
      document.getElementById('form').scrollIntoView({ behavior: "smooth" });
    }

    // üü§ ELIMINAR
    function del(i){
      if(confirm('¬øEliminar producto?')){
        productos.splice(i,1);
        render(productos);
        saveToGitHub(JSON.stringify(productos,null,2));
      }
    }

    // üü§ BOT√ìN SUBIR
    const btnSubir=document.getElementById('btnSubir');
    window.addEventListener('scroll',()=>{ btnSubir.style.display=window.scrollY>300?'block':'none'; });
    btnSubir.addEventListener('click',()=>{ window.scrollTo({top:0,behavior:'smooth'}); });

    // üü§ INICIAR
    loadProducts();
    if(getToken()){ document.getElementById('tokenStatus').innerText="üîê Token cargado."; }
  </script>
</body>
</html>
