<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Carta</title>

  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:18px;background:#f7f3f0;color:#333}
    h1{text-align:center;color:#806250;margin-bottom:10px}
    .topRow{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:10px}
    .controls{display:flex;gap:8px;align-items:center}
    input[type="text"], input[type="password"], textarea{
      padding:8px;border-radius:6px;border:1px solid #ccc;width:100%;box-sizing:border-box
    }
    button{
      background:#806250;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer
    }
    button.secondary{background:#5c8a50}
    button.danger{background:#c0392b}
    form{background:#fff;padding:12px;border-radius:10px;margin-bottom:12px;display:none}
    table{width:100%;border-collapse:collapse;background:#fff}
    th,td{border:1px solid #ddd;padding:8px;vertical-align:top}
    th{background:#806250;color:#fff}
    img.mini{max-width:60px;border-radius:6px}
    #guardarTodos{
      position:fixed;top:18px;right:18px;z-index:1200;padding:10px 14px;
      background:#a07b68;color:#fff;border-radius:8px
    }
    .small{font-size:13px;color:#666}
    .toast {
      position: fixed; top: 24px; right: 24px; z-index: 2000; padding: 12px 16px;
      border-radius: 8px; color: white; font-weight: 600; box-shadow: 0 6px 18px rgba(0,0,0,0.15);
      opacity: 0; transform: translateY(-10px); transition: opacity .25s ease, transform .25s ease; max-width: 360px;
    }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.ok { background: #2ecc71; }
    .toast.info { background: #3498db; }
    .toast.err { background: #e74c3c; }

    @media(max-width:720px){
      .topRow{flex-direction:column;align-items:flex-start}
      table{font-size:13px}
    }
  </style>
</head>
<body>

<h1>Admin Carta</h1>

<div class="topRow">
  <div style="flex:1">
    <div style="display:flex;gap:8px;align-items:center">
      <label style="min-width:40px">Token:</label>
      <input type="password" id="token" placeholder="Pegar token de GitHub" style="max-width:420px">
      <button onclick="saveToken()">Guardar</button>
      <button onclick="clearToken()">Borrar</button>
      <span class="small" id="tokenStatus" style="margin-left:8px">No guardado</span>
    </div>
  </div>

  <div class="controls">
    <input id="search" placeholder="Buscar..." oninput="filterProducts()"
           style="min-width:180px;max-width:360px">
    <button id="toggleFormBtn" onclick="toggleForm()">+ Agregar producto</button>
  </div>
</div>

<button id="guardarTodos" onclick="guardarTodosLosPrecios()">
  üíæ Guardar TODOS los cambios
</button>

<form id="form">
  <input type="hidden" id="editIndex">
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
    <div>
      <label>Nombre</label>
      <input id="nombre" type="text">
    </div>

    <div>
      <label>Precio</label>
      <input id="precio" type="text" placeholder="Ej: 3400">
    </div>

    <div style="grid-column:1/3">
      <label>Descripci√≥n</label>
      <textarea id="descripcion" rows="3"></textarea>
    </div>

    <div>
      <label>Imagen (ruta o URL)</label>
      <input id="imagen" type="text" oninput="previewImage()">
      <img id="preview" class="previewImg" style="display:none;max-width:120px;border-radius:6px;margin-top:8px">
    </div>

    <div>
      <label>Categor√≠a</label>
      <input id="categoria" type="text">
    </div>
  </div>

  <div style="margin-top:10px;display:flex;gap:8px">
    <button type="button" onclick="guardarFormulario()">Guardar</button>
    <button type="button" onclick="cancelForm()" style="background:#999">Cancelar</button>
  </div>
</form>

<table aria-label="Productos">
  <thead>
    <tr>
      <th style="width:80px">Imagen</th>
      <th>Nombre</th>
      <th>Descripci√≥n</th>
      <th>Categor√≠a</th>
      <th style="width:100px">Precio</th>
      <th style="width:180px">Acciones</th>
    </tr>
  </thead>
  <tbody id="tbody"></tbody>
</table>

<script>

/**************************************
 * 1) CONFIG ‚Äî MODIFICAR SOLO ESTO:
 **************************************/
const USERNAME = "cholose10";   // ‚Üê CAMBIAR A TU USER
const REPO = "cartafrench";     // ‚Üê CAMBIAR A TU REPO
const BRANCH = "main";

const MAIN_JSON = "productos.json";
const EN_JSON = "productos-en.json";
const PT_JSON = "productos-port.json";

let productos = [];
/**********************************************************
 * Toast
 **********************************************************/
function showToast(msg, variant = 'ok', timeout = 3000){
  const div = document.createElement('div');
  div.className = 'toast ' + variant;
  div.innerText = msg;
  document.body.appendChild(div);
  requestAnimationFrame(()=>div.classList.add('show'));
  setTimeout(()=>{
    div.classList.remove('show');
    setTimeout(()=>div.remove(),300);
  }, timeout);
}

/**********************************************************
 * Token
 **********************************************************/
function saveToken(){
  const t = document.getElementById('token').value.trim();
  if(!t){ showToast("Peg√° tu token", "err"); return; }
  localStorage.setItem("github_token", t);
  document.getElementById("tokenStatus").innerText = "Token guardado";
  showToast("Token guardado");
}

function clearToken(){
  localStorage.removeItem("github_token");
  document.getElementById("tokenStatus").innerText = "Token borrado";
  showToast("Token borrado","info");
}

function getToken(){
  return localStorage.getItem("github_token");
}

(function initToken(){
  const t = getToken();
  if(t) document.getElementById("tokenStatus").innerText = "Token guardado";
})();

/**********************************************************
 * Utilidades
 **********************************************************/
function sanitizePrice(v){
  return String(v || "").replace(/[^\d]/g,"");
}

function extractNumberFromProdId(id){
  if(!id) return null;
  const m = String(id).match(/(\d+)$/);
  return m ? Number(m[1]) : null;
}

function generateNextProdId(){
  let max = 0;
  for(const p of productos){
    const num = extractNumberFromProdId(p.id || "");
    if(Number.isFinite(num) && num > max) max = num;
  }
  const next = max + 1;
  return "prod" + String(next).padStart(4,"0");
}

/**********************************************************
 * Ordenar campos por idioma
 **********************************************************/
function ordenarCamposPorIdioma(item, idioma){
  const id = item.id || "";

  if(idioma === "EN"){
    return {
      id,
      name: item.name || item.nombre || "",
      description: item.description || item.descripcion || "",
      price: item.price || item.precio || "",
      image: item.image || item.imagen || "",
      category: item.category || item.categoria || ""
    };
  }

  if(idioma === "PT"){
    return {
      nome: item.nome || item.nombre || "",
      descricao: item.descricao || item.descripcion || "",
      preco: item.preco || item.precio || "",
      imagem: item.imagem || item.imagen || "",
      categoria: item.categoria || item.category || "",
      id
    };
  }

  return {
    nombre: item.nombre || item.name || "",
    descripcion: item.descripcion || item.description || "",
    precio: item.precio || item.price || "",
    imagen: item.imagen || item.image || "",
    categoria: item.categoria || item.category || "",
    id
  };
}

/**********************************************************
 * Cargar productos.json
 **********************************************************/
async function loadProducts(){
  try{
    const r = await fetch(`https://raw.githubusercontent.com/${USERNAME}/${REPO}/${BRANCH}/${MAIN_JSON}`);
    if(!r.ok) throw new Error("No se pudo cargar productos.json");
    const arr = await r.json();

    productos = arr.map(item => ({
      id: item.id || "",
      nombre: item.nombre || item.name || "",
      descripcion: item.descripcion || item.description || "",
      precio: String(item.precio || item.price || ""),
      imagen: item.imagen || item.image || "",
      categoria: item.categoria || item.category || ""
    }));

    let fixed = false;
    productos.forEach(p=>{
      if(!p.id || !/^prod\d{4}$/.test(p.id)){
        p.id = generateNextProdId();
        fixed = true;
      }
    });

    if(fixed) showToast("IDs reparados","info");

    render(productos);

  }catch(e){
    console.error(e);
    showToast("Error cargando productos.json","err");
  }
}

/**********************************************************
 * Render tabla
 **********************************************************/
function render(lista){
  const tb = document.getElementById("tbody");
  tb.innerHTML = "";

  lista.forEach((p,i)=>{
    const tr = document.createElement("tr");

    // imagen
    const tdImg = document.createElement("td");
    const im = document.createElement("img");
    im.className = "mini";
    im.src = p.imagen || "";
    im.onerror = ()=>im.style.display="none";
    tdImg.appendChild(im);
    tr.appendChild(tdImg);

    // nombre
    const tdNom = document.createElement("td");
    const inNom = document.createElement("input");
    inNom.type = "text";
    inNom.value = p.nombre;
    inNom.oninput = e => p.nombre = e.target.value;
    tdNom.appendChild(inNom);
    tr.appendChild(tdNom);

    // descripcion
    const tdDes = document.createElement("td");
    const inDes = document.createElement("textarea");
    inDes.rows = 2;
    inDes.value = p.descripcion;
    inDes.oninput = e => p.descripcion = e.target.value;
    tdDes.appendChild(inDes);
    tr.appendChild(tdDes);

    // categoria
    const tdCat = document.createElement("td");
    const inCat = document.createElement("input");
    inCat.type = "text";
    inCat.value = p.categoria;
    inCat.oninput = e => p.categoria = e.target.value;
    tdCat.appendChild(inCat);
    tr.appendChild(tdCat);

    // precio
    const tdPre = document.createElement("td");
    const inPre = document.createElement("input");
    inPre.type = "text";
    inPre.value = p.precio;
    inPre.oninput = e => p.precio = e.target.value;
    tdPre.appendChild(inPre);
    tr.appendChild(tdPre);

    // acciones
    const tdAct = document.createElement("td");
    const btnEdit = document.createElement("button");
    const btnSave = document.createElement("button");
    const btnDel = document.createElement("button");

    btnSave.textContent = "Guardar";
    btnSave.onclick = ()=>guardarFila(i);

    btnEdit.textContent = "Editar";
    btnEdit.style.background="#2980b9";
    btnEdit.onclick = ()=>loadIntoForm(i);

    btnDel.textContent = "Eliminar";
    btnDel.className = "danger";
    btnDel.onclick = ()=>eliminarProducto(i);

    tdAct.appendChild(btnSave);
    tdAct.appendChild(btnEdit);
    tdAct.appendChild(btnDel);

    tr.appendChild(tdAct);
    tb.appendChild(tr);
  });
}

/**********************************************************
 * Formulario de edici√≥n
 **********************************************************/
function toggleForm(){
  const f = document.getElementById("form");
  const visible = f.style.display === "block";
  f.style.display = visible ? "none" : "block";
}

function loadIntoForm(i){
  const p = productos[i];
  if(!p) return;

  document.getElementById("editIndex").value = i;
  document.getElementById("nombre").value = p.nombre;
  document.getElementById("descripcion").value = p.descripcion;
  document.getElementById("precio").value = p.precio;
  document.getElementById("imagen").value = p.imagen;
  document.getElementById("categoria").value = p.categoria;

  previewImage();

  document.getElementById("form").style.display = "block";

  // ‚≠ê SCROLL AUTOM√ÅTICO AL FORMULARIO
  document.getElementById("form").scrollIntoView({ behavior:"smooth", block:"start" });
}

function cancelForm(){
  document.getElementById("editIndex").value = "";
  document.getElementById("form").style.display = "none";
}

function previewImage(){
  const v = document.getElementById("imagen").value.trim();
  const img = document.getElementById("preview");
  if(!v){ img.style.display="none"; return; }
  img.src = v;
  img.style.display="block";
}

function guardarFormulario(){
  const i = document.getElementById("editIndex").value;
  const obj = {
    nombre: document.getElementById("nombre").value.trim(),
    descripcion: document.getElementById("descripcion").value.trim(),
    precio: sanitizePrice(document.getElementById("precio").value.trim()),
    imagen: document.getElementById("imagen").value.trim(),
    categoria: document.getElementById("categoria").value.trim()
  };

  if(!obj.nombre){ showToast("Falta nombre","err"); return; }
  if(!obj.precio){ showToast("Falta precio","err"); return; }

  if(i !== ""){
    const idx = Number(i);
    productos[idx] = { ...productos[idx], ...obj };
  } else {
    const id = generateNextProdId();
    productos.push({ id, ...obj });
  }

  render(productos);
  showToast("Guardado local");
  document.getElementById("form").style.display="none";
}

/**********************************************************
 * Eliminar
 **********************************************************/
function eliminarProducto(i){
  if(!confirm("Eliminar producto?")) return;
  productos.splice(i,1);
  render(productos);
}

/**********************************************************
 * Tomar valores actuales de la tabla
 **********************************************************/
function refrescarArrayDesdeTabla(){
  const filas = document.querySelectorAll("#tbody tr");
  const nuevos = [];

  filas.forEach((fila, idx)=>{
    const c = fila.querySelectorAll("td");

    const nombre = c[1].querySelector("input").value.trim();
    const descripcion = c[2].querySelector("textarea").value.trim();
    const categoria = c[3].querySelector("input").value.trim();
    const precio = sanitizePrice(c[4].querySelector("input").value.trim());

    const id = productos[idx]?.id || generateNextProdId();
    const imagen = productos[idx]?.imagen || "";

    nuevos.push({ id, nombre, descripcion, categoria, precio, imagen });
  });

  productos = nuevos;
}
/**********************************************************
 * GitHub - obtener info archivo
 **********************************************************/
async function githubGetFileInfo(path){
  const token = getToken();
  const headers = token
    ? { Authorization: "token " + token, Accept: "application/vnd.github.v3+json" }
    : { Accept: "application/vnd.github.v3+json" };

  const url = `https://api.github.com/repos/${USERNAME}/${REPO}/contents/${path}?ref=${BRANCH}`;
  const res = await fetch(url, { headers });

  if(!res.ok){
    const txt = await res.text().catch(()=> "");
    throw new Error(`GitHub GET ${path} ‚Üí ${res.status}: ${txt}`);
  }

  return await res.json();   // contiene .sha
}

/**********************************************************
 * GitHub PUT archivo (con SHA obligatorio)
 **********************************************************/
async function githubPutFile(path, contentString, message, sha){
  const token = getToken();
  if(!token) throw new Error("Falta token");

  const url = `https://api.github.com/repos/${USERNAME}/${REPO}/contents/${path}`;

  const body = {
    message,
    content: btoa(unescape(encodeURIComponent(contentString))),
    branch: BRANCH
  };

  if(sha) body.sha = sha;

  const res = await fetch(url, {
    method: "PUT",
    headers:{
      Authorization: "token " + token,
      "Content-Type": "application/json",
      Accept: "application/vnd.github.v3+json"
    },
    body: JSON.stringify(body)
  });

  const data = await res.json().catch(()=> ({}));

  if(!res.ok){
    throw new Error(`GitHub PUT ${path} ‚Üí ${res.status}: ${data.message || JSON.stringify(data)}`);
  }

  return data;
}

/**********************************************************
 * Guardar productos.json (SHA fresco ANTES del PUT)
 **********************************************************/
async function saveMainJson(arr, commitMessage){
  const out = arr.map(item => ordenarCamposPorIdioma(item, "ES"));
  const contentString = JSON.stringify(out, null, 2);

  let shaActual;

  // 1) Intentar obtener SHA actual
  try{
    const info = await githubGetFileInfo(MAIN_JSON);
    shaActual = info.sha;
  }catch(e){
    shaActual = undefined; // archivo no existe ‚Üí se crear√°
  }

  // 2) Obtener SHA fresco otra vez justo antes de subir
  try{
    const info2 = await githubGetFileInfo(MAIN_JSON);
    shaActual = info2.sha;
  }catch(e){}

  // 3) Subir archivo
  await githubPutFile(MAIN_JSON, contentString, commitMessage, shaActual);
}

/**********************************************************
 * Sincronizar precios en EN y PT
 **********************************************************/
async function syncPricesToLangs(){

  const byId = {};
  productos.forEach(p => { if(p.id) byId[p.id] = p; });

  async function processLangFile(filename, idioma){
    let info = null;

    try{
      info = await githubGetFileInfo(filename);
    }catch(e){
      info = null; // no existe ‚Üí se crea despu√©s
    }

    let arr = [];

    if(info && info.content){
      const raw = info.content.replace(/\n/g, "");
      const decoded = decodeURIComponent(escape(window.atob(raw)));
      try{
        arr = JSON.parse(decoded);
        if(!Array.isArray(arr)) arr = [];
      }catch(e){
        arr = [];
      }
    }

    let changed = false;

    // sincronizar solo precios
    const newArr = arr.map(item => {
      const id = item.id;
      if(id && byId[id]){
        const nuevo = sanitizePrice(byId[id].precio);

        if("precio" in item && String(item.precio) !== nuevo){
          item.precio = nuevo; changed = true;
        }
        if("price" in item && String(item.price) !== nuevo){
          item.price = nuevo; changed = true;
        }
        if("preco" in item && String(item.preco) !== nuevo){
          item.preco = nuevo; changed = true;
        }
      }

      return ordenarCamposPorIdioma(item, idioma);
    });

    // si archivo no exist√≠a ‚Üí crearlo entero directo
    if(info === null){
      const created = [];
      for(const pid in byId){
        const p = byId[pid];
        created.push( ordenarCamposPorIdioma({
          id: p.id,
          nombre: p.nombre,
          descripcion: p.descripcion,
          precio: p.precio,
          imagen: p.imagen,
          categoria: p.categoria
        }, idioma) );
      }

      const contentString = JSON.stringify(created, null, 2);
      await githubPutFile(filename, contentString, `Crea ${filename}`, undefined);
      return;
    }

    // si hubo cambios, subirlos
    if(changed){
      const latest = await githubGetFileInfo(filename);
      const contentString = JSON.stringify(newArr, null, 2);
      await githubPutFile(filename, contentString, `Sync precios desde ES`, latest.sha);
    }
  }

  await processLangFile(EN_JSON, "EN");
  await processLangFile(PT_JSON, "PT");
}

/**********************************************************
 * Guardar UNA fila
 **********************************************************/
async function guardarFila(i){
  try{
    const p = productos[i];
    if(!p) return;

    p.precio = sanitizePrice(p.precio);
    if(!p.id || !/^prod\d{4}$/.test(p.id)) p.id = generateNextProdId();

    // 1) Guardar ES
    await saveMainJson(productos, `Actualiza ${p.id}`);

    // 2) Sync EN / PT
    await syncPricesToLangs();

    showToast("Producto guardado", "ok");
    render(productos);

  }catch(e){
    console.error(e);
    showToast("Error: " + e.message, "err");
  }
}

/**********************************************************
 * Guardar TODOS los cambios
 **********************************************************/
async function guardarTodosLosPrecios(){

  try{
    refrescarArrayDesdeTabla();

    productos = productos.map(p => ({
      ...p,
      precio: sanitizePrice(p.precio)
    }));

    await saveMainJson(productos, `Guardar TODOS`);
    await syncPricesToLangs();

    showToast("Todos los cambios guardados", "ok");
    render(productos);

  }catch(e){
    console.error(e);
    showToast("Error al guardar todos: " + e.message, "err");
  }
}

/**********************************************************
 * B√∫squeda
 **********************************************************/
function filterProducts(){
  const q = document.getElementById("search").value.toLowerCase().trim();
  if(!q){ render(productos); return; }

  const f = productos.filter(p =>
    (p.nombre||"").toLowerCase().includes(q) ||
    (p.descripcion||"").toLowerCase().includes(q) ||
    (p.categoria||"").toLowerCase().includes(q)
  );

  render(f);
}

/**********************************************************
 * INIT
 **********************************************************/
document.addEventListener("DOMContentLoaded", loadProducts);
</script>

</body>
</html>
