<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin - Tilo Caf√© French</title>
  <style>
    body{font-family:Arial,sans-serif;margin:20px;background:#f7f3f0;color:#333;}
    h1{text-align:center;color:#806250;}
    form{background:#fff;padding:15px;border-radius:10px;margin-bottom:20px;transition:box-shadow .4s;}
    form.editando{box-shadow:0 0 15px #806250;}
    input,textarea,datalist{width:100%;padding:8px;margin:6px 0;border:1px solid #ccc;border-radius:6px;}
    table{width:100%;border-collapse:collapse;background:#fff;}
    th,td{border:1px solid #ddd;padding:8px;text-align:left;}
    th{background:#806250;color:#fff;}
    img{max-width:60px;border-radius:6px;}
    button{cursor:pointer;background:#806250;color:#fff;border:none;padding:6px 10px;border-radius:6px;}
    #preview{max-width:100px;margin-top:5px;display:block;}
    .search-row{display:flex;gap:8px;margin-bottom:12px;align-items:center;}
    .search-row input{flex:1;padding:8px;border-radius:6px;border:1px solid #ccc;}
    .search-row button{padding:8px 12px;border-radius:6px;}
    #btnArriba{position:fixed;bottom:25px;right:25px;width:45px;height:45px;border-radius:50%;background:#806250;color:#fff;border:none;display:none;cursor:pointer;}
  </style>
</head>
<body>
  <h1>Admin - Tilo Caf√© French</h1>

  <div style="background:#eee;padding:10px;border-radius:8px;margin-bottom:12px;">
    <label>Token de GitHub:</label><br>
    <input id="token" type="password" placeholder="Pega tu token aqu√≠" style="width:70%;padding:8px;">
    <button onclick="saveToken()">Guardar Token</button>
    <button onclick="clearToken()">Borrar Token</button>
    <p id="tokenStatus"></p>
  </div>

  <div class="search-row">
    <input id="search" placeholder="Buscar producto... (Enter para buscar)">
    <button id="btnSearch">Buscar</button>
  </div>

  <form id="form">
    <input type="hidden" id="editIndex">
    <label>Nombre</label><input id="nombre" required>
    <label>Descripci√≥n</label><textarea id="descripcion" required></textarea>
    <label>Precio</label><input id="precio" type="number" required>
    <label>Imagen (ej: img/foto.jpg)</label><input id="imagen" required oninput="previewImage()">
    <img id="preview" src="" alt="Preview">
    <label>Categor√≠a</label><input list="listaCategorias" id="categoria" required><datalist id="listaCategorias"></datalist>
    <button type="submit">Guardar</button>
  </form>

  <h2 id="tablaTitulo">Productos</h2>
  <table><thead><tr><th>Imagen</th><th>Nombre</th><th>Descripci√≥n</th><th>Categor√≠a</th><th>Precio</th><th>Acciones</th></tr></thead><tbody id="tbody"></tbody></table>
  <button id="btnArriba" title="Subir">‚¨ÜÔ∏è</button>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const USER='cholose10'; const REPO='cartafrench'; const FILE='productos.json';
  const RAW_URL=`https://raw.githubusercontent.com/${USER}/${REPO}/main/${FILE}`;
  let productos=[];

  const tokenEl=document.getElementById('token'); const statusEl=document.getElementById('tokenStatus');
  function saveToken(){const t=tokenEl.value.trim();if(!t)return alert('Ingresa token');localStorage.setItem('github_token',t);tokenEl.value='';statusEl.innerText='‚úÖ Token guardado';}
  function clearToken(){localStorage.removeItem('github_token');statusEl.innerText='‚ö†Ô∏è Token borrado';}
  function getToken(){return localStorage.getItem('github_token');}

  async function loadProducts(){try{const r=await fetch(RAW_URL,{cache:"no-store"});productos=await r.json();render(productos);updateCats();}catch(e){alert("Error cargando productos");}}
  function render(list){const tb=document.getElementById('tbody');tb.innerHTML='';if(!list.length)return tb.innerHTML='<tr><td colspan="6" style="text-align:center">Sin productos</td></tr>';list.forEach((p,i)=>{tb.innerHTML+=`<tr><td><img src="${p.imagen}"></td><td>${p.nombre}</td><td>${p.descripcion}</td><td>${p.categoria}</td><td>$${p.precio}</td><td><button onclick="edit(${i})">Editar</button><button onclick="del(${i})">Eliminar</button></td></tr>`;});}

  function updateCats(){const dat=document.getElementById('listaCategorias');dat.innerHTML='';[...new Set(productos.map(p=>p.categoria))].sort().forEach(c=>{dat.innerHTML+=`<option value="${c}">`;});}

  // BUSCAR
  const s=document.getElementById('search'); const b=document.getElementById('btnSearch');
  function buscar(){const q=s.value.toLowerCase().trim();const res=productos.filter(p=>(p.nombre+p.descripcion+p.categoria).toLowerCase().includes(q));render(res);document.getElementById('tablaTitulo').scrollIntoView({behavior:'smooth'});}
  s.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();buscar();}}); b.addEventListener('click',buscar);

  window.previewImage=()=>document.getElementById('preview').src=document.getElementById('imagen').value.trim()||'';

  async function saveToGitHub(newContent){const TOKEN=getToken();if(!TOKEN)return alert("Guard√° tu token primero");const api=`https://api.github.com/repos/${USER}/${REPO}/contents/${FILE}`;const get=await fetch(api,{headers:{Authorization:`token ${TOKEN}`}});const data=await get.json();const res=await fetch(api,{method:'PUT',headers:{Authorization:`token ${TOKEN}`,'Content-Type':'application/json'},body:JSON.stringify({message:'update admin',content:btoa(unescape(encodeURIComponent(newContent))),sha:data.sha})});alert(res.ok?'‚úÖ Cambios guardados':'‚ùå Error al guardar');}

  const form=document.getElementById('form');form.addEventListener('submit',e=>{e.preventDefault();const i=document.getElementById('editIndex').value;const prod={nombre:form.nombre.value,descripcion:form.descripcion.value,precio:parseFloat(form.precio.value),imagen:form.imagen.value,categoria:form.categoria.value};if(i==='')productos.push(prod);else productos[i]=prod;render(productos);updateCats();form.reset();document.getElementById('preview').src='';saveToGitHub(JSON.stringify(productos,null,2));});

  window.edit=i=>{const p=productos[i];form.nombre.value=p.nombre;form.descripcion.value=p.descripcion;form.precio.value=p.precio;form.imagen.value=p.imagen;form.categoria.value=p.categoria;document.getElementById('editIndex').value=i;document.getElementById('preview').src=p.imagen;form.scrollIntoView({behavior:'smooth'});};
  window.del=i=>{if(!confirm('Eliminar producto?'))return;productos.splice(i,1);render(productos);saveToGitHub(JSON.stringify(productos,null,2));};

  const btn=document.getElementById('btnArriba');window.addEventListener('scroll',()=>btn.style.display=window.scrollY>300?'block':'none');btn.addEventListener('click',()=>window.scrollTo({top:0,behavior:'smooth'}));

  loadProducts();if(getToken())statusEl.innerText='üîê Token cargado';
});
</script>
</body>
</html>
