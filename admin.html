<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin - Tilo Caf√© French</title>
  <style>
    body{font-family:Arial,sans-serif;margin:20px;background:#f7f3f0;color:#333;}
    h1{text-align:center;color:#806250;}
    form{background:#fff;padding:15px;border-radius:10px;margin-bottom:20px;transition:box-shadow .4s;}
    form.editando{box-shadow:0 0 15px #806250;}
    input,textarea,datalist{width:100%;padding:8px;margin:6px 0;border:1px solid #ccc;border-radius:6px;}
    table{width:100%;border-collapse:collapse;background:#fff;}
    th,td{border:1px solid #ddd;padding:8px;text-align:left;}
    th{background:#806250;color:#fff;}
    img{max-width:60px;border-radius:6px;}
    button{cursor:pointer;background:#806250;color:#fff;border:none;padding:6px 10px;border-radius:6px;}
    #preview{max-width:100px;margin-top:5px;display:block;}
    .search-row{display:flex;gap:8px;margin-bottom:12px;align-items:center;}
    .search-row input{flex:1;padding:8px;border-radius:6px;border:1px solid #ccc;}
    .search-row button{padding:8px 12px;border-radius:6px;}
    #btnArriba{position:fixed;bottom:25px;right:25px;width:45px;height:45px;border-radius:50%;background:#806250;color:#fff;border:none;display:none;cursor:pointer;}
  </style>
</head>
<body>
  <h1>Admin - Tilo Caf√© French</h1>

  <div style="background:#eee;padding:10px;border-radius:8px;margin-bottom:12px;">
    <label>Token de GitHub:</label><br>
    <input id="token" type="password" placeholder="Pega tu token aqu√≠" style="width:70%;padding:8px;">
    <button onclick="saveToken()">Guardar Token</button>
    <button onclick="clearToken()">Borrar Token</button>
    <p id="tokenStatus"></p>
  </div>

  <div class="search-row">
    <input id="search" placeholder="Buscar producto... (Enter para buscar)">
    <button id="btnSearch">Buscar</button>
  </div>

  <form id="form">
    <input type="hidden" id="editIndex">
    <label>Nombre</label><input id="nombre" required>
    <label>Descripci√≥n</label><textarea id="descripcion" required></textarea>
    <label>Precio</label><input id="precio" type="number" required>
    <label>Imagen (ej: img/foto.jpg)</label><input id="imagen" required oninput="previewImage()">
    <img id="preview" src="" alt="Preview">
    <label>Categor√≠a</label><input list="listaCategorias" id="categoria" required><datalist id="listaCategorias"></datalist>
    <button type="submit">Guardar</button>
  </form>

  <h2 id="tablaTitulo">Productos</h2>
  <table><thead><tr><th>Imagen</th><th>Nombre</th><th>Descripci√≥n</th><th>Categor√≠a</th><th>Precio</th><th>Acciones</th></tr></thead><tbody id="tbody"></tbody></table>
  <button id="btnArriba" title="Subir">‚¨ÜÔ∏è</button>

<script>
  const USERNAME = "cholose10";
  const REPO = "cartaaguero"; // ‚ö†Ô∏è cambiar por "cartafrench" en la otra carta
  const FILE_PATH = "productos.json";
  let productos = [];
  let listaMostrada = []; // ‚Üê nueva variable que mantiene lo que se muestra

  // TOKEN
  function saveToken(){
    const t=document.getElementById('token').value.trim();
    if(t){localStorage.setItem('github_token',t);document.getElementById('token').value='';
      document.getElementById('tokenStatus').innerText="‚úÖ Token guardado.";}
  }
  function clearToken(){localStorage.removeItem('github_token');
    document.getElementById('tokenStatus').innerText="‚ö†Ô∏è Token borrado.";}
  function getToken(){return localStorage.getItem('github_token');}

  // CARGAR PRODUCTOS
  async function loadProducts(){
    const url=`https://raw.githubusercontent.com/${USERNAME}/${REPO}/main/${FILE_PATH}`;
    const res=await fetch(url);
    productos=await res.json();
    listaMostrada=[...productos];
    render(listaMostrada);
    updateCategoryList();
  }

  // RENDER TABLA
  function render(lista){
    const tb=document.getElementById('tbody');
    tb.innerHTML='';
    lista.forEach((p,i)=>{
      tb.innerHTML+=`
        <tr>
          <td><img src="${p.imagen}" alt=""></td>
          <td>${p.nombre}</td>
          <td>${p.descripcion}</td>
          <td>${p.categoria}</td>
          <td>$${p.precio}</td>
          <td>
            <button onclick="edit(${i})">Editar</button>
            <button onclick="del(${i})">Eliminar</button>
          </td>
        </tr>`;
    });
  }

  // ACTUALIZAR CATEGOR√çAS
  function updateCategoryList(){
    const cats=[...new Set(productos.map(p=>p.categoria))].sort();
    const datalist=document.getElementById('listaCategorias');
    datalist.innerHTML='';
    cats.forEach(c=>{
      const opt=document.createElement('option');
      opt.value=c;
      datalist.appendChild(opt);
    });
  }

  // BUSCADOR
  const searchInput=document.getElementById("search");
  searchInput.addEventListener("keypress",function(e){
    if(e.key==="Enter"){e.preventDefault();filterProducts();}
  });

  function filterProducts(){
    const q=searchInput.value.toLowerCase().trim();
    listaMostrada=productos.filter(p=>
      p.nombre.toLowerCase().includes(q)||
      p.descripcion.toLowerCase().includes(q)||
      p.categoria.toLowerCase().includes(q)
    );
    render(listaMostrada);
    if(listaMostrada.length>0){
      document.getElementById("tablaTitulo").scrollIntoView({behavior:"smooth"});
    }
  }

  // PREVIEW
  function previewImage(){
    const src=document.getElementById('imagen').value.trim();
    document.getElementById('preview').src=src||'';
  }

  // GUARDAR EN GITHUB
  async function saveToGitHub(newContent){
    const TOKEN=getToken();
    if(!TOKEN){alert("‚ö†Ô∏è Guard√° tu token primero.");return;}
    const apiUrl=`https://api.github.com/repos/${USERNAME}/${REPO}/contents/${FILE_PATH}`;
    const getRes=await fetch(apiUrl,{headers:{Authorization:`token ${TOKEN}`}});
    const data=await getRes.json();
    const updateRes=await fetch(apiUrl,{
      method:"PUT",
      headers:{
        "Authorization":`token ${TOKEN}`,
        "Content-Type":"application/json"
      },
      body:JSON.stringify({
        message:"Actualizaci√≥n desde admin.html",
        content:btoa(unescape(encodeURIComponent(newContent))),
        sha:data.sha
      })
    });
    if(updateRes.ok){alert("‚úÖ Cambios guardados en GitHub.");}
    else{alert("‚ùå Error al guardar en GitHub.");}
  }

  // GUARDAR PRODUCTO
  document.getElementById('form').onsubmit=function(e){
    e.preventDefault();
    const idx=document.getElementById('editIndex').value;
    const prod={
      nombre:document.getElementById('nombre').value,
      descripcion:document.getElementById('descripcion').value,
      precio:parseFloat(document.getElementById('precio').value),
      imagen:document.getElementById('imagen').value,
      categoria:document.getElementById('categoria').value
    };
    if(idx===''){productos.push(prod);}
    else{productos[idx]=prod;document.getElementById('editIndex').value='';}
    listaMostrada=[...productos];
    render(listaMostrada);
    updateCategoryList();
    this.reset();
    document.getElementById('preview').src='';
    saveToGitHub(JSON.stringify(productos,null,2));
  }

  // EDITAR (usa listaMostrada para buscar el real)
  function edit(i){
    const p=listaMostrada[i];
    const realIndex=productos.indexOf(p);
    if(realIndex===-1){alert("Error: producto no encontrado.");return;}
    document.getElementById('nombre').value=p.nombre;
    document.getElementById('descripcion').value=p.descripcion;
    document.getElementById('precio').value=p.precio;
    document.getElementById('imagen').value=p.imagen;
    document.getElementById('categoria').value=p.categoria;
    document.getElementById('editIndex').value=realIndex;
    document.getElementById('preview').src=p.imagen;
    const form=document.getElementById('form');
    form.scrollIntoView({behavior:"smooth",block:"start"});
    form.classList.add('editando');
    setTimeout(()=>form.classList.remove('editando'),2000);
  }

  // ELIMINAR (tambi√©n usa listaMostrada)
  function del(i){
    if(confirm('¬øEliminar producto?')){
      const p=listaMostrada[i];
      const realIndex=productos.indexOf(p);
      if(realIndex!==-1){
        productos.splice(realIndex,1);
        listaMostrada=[...productos];
        render(listaMostrada);
        updateCategoryList();
        saveToGitHub(JSON.stringify(productos,null,2));
      }
    }
  }

  // BOT√ìN ARRIBA
  window.onscroll=function(){
    document.getElementById("btnArriba").style.display=window.scrollY>300?"block":"none";
  };
  function subir(){
    document.getElementById("form").scrollIntoView({behavior:"smooth"});
  }

  // INICIO
  loadProducts();
  if(getToken()){document.getElementById('tokenStatus').innerText="üîê Token cargado.";}
</script>

