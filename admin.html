<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Carta - Tilo Caf√© Ag√ºero (Buscador robusto)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f7f3f0; color: #333; }
    h1 { text-align: center; color: #806250; }
    form { background: #fff; padding: 15px; border-radius: 10px; margin-bottom: 20px; transition: box-shadow 0.5s; }
    form.editando { box-shadow: 0 0 15px #806250; }
    input, textarea, datalist { width: 100%; padding: 8px; margin: 6px 0; border: 1px solid #ccc; border-radius: 6px; }
    table { width: 100%; border-collapse: collapse; background: #fff; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #806250; color: white; }
    img { max-width: 60px; border-radius: 6px; }
    button { cursor: pointer; background: #806250; color: white; border: none; padding: 6px 10px; border-radius: 6px; transition: background 0.3s; }
    button:hover { background: #a07b68; }
    #preview { max-width: 100px; margin-top: 5px; display: block; border-radius: 8px; }
    #search { width: 60%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; }
    .search-container { display: flex; gap: 10px; margin-bottom: 15px; align-items:center; }
    #btnArriba { position: fixed; bottom: 25px; right: 25px; background: #806250; color: white; border: none; border-radius: 50%; width: 45px; height: 45px; font-size: 20px; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.3); display: none; z-index: 100; transition: background 0.3s; }
    #btnArriba:hover { background: #a07b68; }
    .small-note { font-size:12px; color:#666; margin-top:6px; }
  </style>
</head>
<body>
  <h1>Panel de Administraci√≥n - Tilo Caf√© Ag√ºero</h1>

  <!-- TOKEN -->
  <div style="margin-bottom:15px; background:#eee; padding:10px; border-radius:8px;">
    <label for="token">Token de GitHub:</label><br>
    <input type="password" id="token" placeholder="Pega tu token aqu√≠" style="width:70%; padding:8px;">
    <button onclick="saveToken()">Guardar Token</button>
    <button onclick="clearToken()">Borrar Token</button>
    <p id="tokenStatus"></p>
    <div class="small-note">Si la carga de productos falla, revis√° la consola (Ctrl+Shift+J) para ver el error.</div>
  </div>

  <!-- BUSCADOR -->
  <div class="search-container">
    <input type="text" id="search" placeholder="Buscar producto...">
    <button onclick="filterProducts()">üîç Buscar</button>
    <button onclick="resetFilter()" title="Mostrar todo">üîÑ Mostrar todo</button>
  </div>

  <!-- FORMULARIO -->
  <form id="form">
    <input type="hidden" id="editIndex">
    <label>Nombre</label>
    <input type="text" id="nombre" required>

    <label>Descripci√≥n</label>
    <textarea id="descripcion" required></textarea>

    <label>Precio</label>
    <input type="number" id="precio" required>

    <label>Imagen (ej: img/foto.jpg)</label>
    <input type="text" id="imagen" required oninput="previewImage()">
    <img id="preview" src="" alt="Vista previa">

    <label>Categor√≠a</label>
    <input list="listaCategorias" type="text" id="categoria" placeholder="Ej: CAFETER√çA, POSTRES, etc." required>
    <datalist id="listaCategorias"></datalist>

    <button type="submit">Guardar</button>
  </form>

  <!-- TABLA -->
  <h2 id="tablaTitulo">Productos</h2>
  <table>
    <thead>
      <tr>
        <th>Imagen</th><th>Nombre</th><th>Descripci√≥n</th><th>Categor√≠a</th><th>Precio</th><th>Acciones</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <button id="btnArriba" onclick="subir()">‚¨ÜÔ∏è</button>

  <script>
    const USERNAME = "cholose10";
    const REPO = "cartaaguero";
    const FILE_PATH = "productos.json";
    let productos = [];

    // TOKEN
    function saveToken(){
      const t = document.getElementById('token').value.trim();
      if(t){
        localStorage.setItem('github_token', t);
        document.getElementById('token').value = '';
        document.getElementById('tokenStatus').innerText = "‚úÖ Token guardado.";
      }
    }
    function clearToken(){
      localStorage.removeItem('github_token');
      document.getElementById('tokenStatus').innerText = "‚ö†Ô∏è Token borrado.";
    }
    function getToken(){ return localStorage.getItem('github_token'); }

    // CARGAR PRODUCTOS (con manejo de errores)
    async function loadProducts(){
      const url = `https://raw.githubusercontent.com/${USERNAME}/${REPO}/main/${FILE_PATH}`;
      try {
        console.log("Cargando productos desde:", url);
        const res = await fetch(url);
        if(!res.ok){
          throw new Error(`HTTP ${res.status} - ${res.statusText}`);
        }
        const data = await res.json();
        if(!Array.isArray(data)){
          console.warn("El JSON no es un array. Forzando a array vac√≠o.", data);
          productos = [];
        } else {
          productos = data;
        }
        render(productos);
        updateCategoryList();
        console.log("Productos cargados:", productos.length);
      } catch (err) {
        console.error("Error cargando productos:", err);
        productos = [];
        render(productos);
        updateCategoryList();
        alert("‚ùå Error al cargar productos. Mir√° la consola para m√°s detalles.");
      }
    }

    // RENDER TABLA (usando acceso seguro a propiedades)
    function render(lista){
      const tb = document.getElementById('tbody');
      tb.innerHTML = '';
      if(!Array.isArray(lista) || lista.length === 0){
        tb.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:12px;">No hay productos</td></tr>`;
        return;
      }
      lista.forEach((p, i) => {
        const nombre = (p && p.nombre) ? escapeHtml(String(p.nombre)) : '‚Äî';
        const desc = (p && p.descripcion) ? escapeHtml(String(p.descripcion)) : '‚Äî';
        const cat = (p && p.categoria) ? escapeHtml(String(p.categoria)) : '‚Äî';
        const precio = (p && (p.precio !== undefined && p.precio !== null)) ? escapeHtml(String(p.precio)) : '‚Äî';
        const imgSrc = (p && p.imagen) ? escapeHtml(String(p.imagen)) : '';

        tb.innerHTML += `
          <tr>
            <td>${imgSrc ? `<img src="${imgSrc}" alt="">` : ''}</td>
            <td>${nombre}</td>
            <td>${desc}</td>
            <td>${cat}</td>
            <td>$${precio}</td>
            <td>
              <button onclick="edit(${i})">Editar</button>
              <button onclick="del(${i})">Eliminar</button>
            </td>
          </tr>
        `;
      });
    }

    // escapar HTML simple para evitar romper la tabla si hay caracteres raros
    function escapeHtml(text){
      return text.replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#039;"})[m]; });
    }

    // UPDATE CATEGOR√çAS
    function updateCategoryList(){
      const cats = [...new Set((productos||[]).map(p => (p && p.categoria) ? p.categoria : '').filter(Boolean))].sort();
      const datalist = document.getElementById('listaCategorias');
      datalist.innerHTML = '';
      cats.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        datalist.appendChild(opt);
      });
    }

    // BUSCADOR - defensivo y con b√∫squeda en tiempo real
    const searchInput = document.getElementById("search");
    searchInput.addEventListener("keypress", function(e){
      if(e.key === "Enter"){
        e.preventDefault();
        filterProducts();
      }
    });
    // b√∫squeda a medida que tipe√°s (opcional)
    let typingTimer;
    searchInput.addEventListener("input", function(){
      clearTimeout(typingTimer);
      typingTimer = setTimeout(()=>filterProducts(false), 250);
    });

    function filterProducts(scrollToResults = true){
      try {
        const q = (searchInput.value || '').toLowerCase().trim();
        if(!q){
          render(productos);
          return;
        }
        const filtrados = (productos || []).filter(p => {
          // usar cadenas seguras (toString) y comprobar existencia
          const nombre = p && p.nombre ? String(p.nombre).toLowerCase() : '';
          const descripcion = p && p.descripcion ? String(p.descripcion).toLowerCase() : '';
          const categoria = p && p.categoria ? String(p.categoria).toLowerCase() : '';
          return nombre.includes(q) || descripcion.includes(q) || categoria.includes(q);
        });
        render(filtrados);
        if(scrollToResults && filtrados.length>0){
          document.getElementById("tablaTitulo").scrollIntoView({behavior:"smooth"});
        }
        console.log(`B√∫squeda: "${q}" ‚Üí ${filtrados.length} resultados`);
      } catch (err) {
        console.error("Error en filterProducts:", err);
        alert("‚ùå Error en la b√∫squeda. Mir√° la consola para m√°s info.");
      }
    }

    function resetFilter(){
      searchInput.value = '';
      render(productos);
    }

    // PREVIEW
    function previewImage(){
      const src = document.getElementById('imagen').value.trim();
      document.getElementById('preview').src = src || '';
    }

    // GUARDAR EN GITHUB (sin cambios funcionales pero con try/catch)
    async function saveToGitHub(newContent){
      const TOKEN = getToken();
      if(!TOKEN){ alert("‚ö†Ô∏è Guard√° tu token primero."); return; }
      const apiUrl = `https://api.github.com/repos/${USERNAME}/${REPO}/contents/${FILE_PATH}`;
      try {
        const getRes = await fetch(apiUrl, { headers: { Authorization: `token ${TOKEN}` }});
        const data = await getRes.json();
        if(!data.sha){
          // si no existe, crear archivo (PUT con no sha puede crear o fallar). Intentaremos igualmente.
          console.warn("No se encontr√≥ SHA (posible archivo nuevo o permisos).", data);
        }
        const updateRes = await fetch(apiUrl, {
          method: "PUT",
          headers: {
            "Authorization": `token ${TOKEN}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            message: "Actualizaci√≥n desde admin.html",
            content: btoa(unescape(encodeURIComponent(newContent))),
            sha: data.sha // si es undefined, github puede rechazar; el usuario ver√° el error en la alerta
          })
        });
        if(updateRes.ok){ alert("‚úÖ Cambios guardados en GitHub."); }
        else{
          const txt = await updateRes.text();
          console.error("Error al guardar en GitHub:", updateRes.status, txt);
          alert("‚ùå Error al guardar en GitHub. Mir√° la consola para m√°s detalles.");
        }
      } catch (err) {
        console.error("Excepci√≥n guardando en GitHub:", err);
        alert("‚ùå Error guardando en GitHub. Mir√° la consola.");
      }
    }

    // GUARDAR PRODUCTO
    document.getElementById('form').onsubmit = function(e){
      e.preventDefault();
      const idx = document.getElementById('editIndex').value;
      const prod = {
        nombre: document.getElementById('nombre').value,
        descripcion: document.getElementById('descripcion').value,
        precio: parseFloat(document.getElementById('precio').value),
        imagen: document.getElementById('imagen').value,
        categoria: document.getElementById('categoria').value
      };
      if(idx === ''){ productos.push(prod); }
      else { productos[idx] = prod; document.getElementById('editIndex').value = ''; }
      render(productos);
      updateCategoryList();
      this.reset();
      document.getElementById('preview').src = '';
      saveToGitHub(JSON.stringify(productos, null, 2));
    }

    // EDITAR
    function edit(i){
      // tomamos el producto basado en el √≠ndice real del array actual
      const p = productos[i];
      if(!p){ alert("No se encontr√≥ el producto para editar."); return; }
      document.getElementById('nombre').value = p.nombre || '';
      document.getElementById('descripcion').value = p.descripcion || '';
      document.getElementById('precio').value = p.precio || '';
      document.getElementById('imagen').value = p.imagen || '';
      document.getElementById('categoria').value = p.categoria || '';
      document.getElementById('editIndex').value = i;
      document.getElementById('preview').src = p.imagen || '';
      const form = document.getElementById('form');
      form.scrollIntoView({behavior:"smooth",block:"start"});
      form.classList.add('editando');
      setTimeout(()=>form.classList.remove('editando'),2000);
    }

    // ELIMINAR
    function del(i){
      if(confirm('¬øEliminar producto?')){
        if(i < 0 || i >= productos.length){ alert("√çndice inv√°lido."); return; }
        productos.splice(i, 1);
        render(productos);
        updateCategoryList();
        saveToGitHub(JSON.stringify(productos, null, 2));
      }
    }

    // BOT√ìN ARRIBA
    window.onscroll = function(){
      document.getElementById("btnArriba").style.display = window.scrollY > 300 ? "block" : "none";
    };
    function subir(){ document.getElementById("form").scrollIntoView({behavior:"smooth"}); }

    // INICIO
    loadProducts();
    if(getToken()){ document.getElementById('tokenStatus').innerText = "üîê Token cargado."; }
  </script>
</body>
</html>
